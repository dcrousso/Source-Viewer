<script>
	"use strict";

	function handleEvent(event) {
		let activeBrowserWindow = safari.application.activeBrowserWindow;
		let url = activeBrowserWindow.activeTab.url;
		let index = activeBrowserWindow.tabs.indexOf(activeBrowserWindow.activeTab);

		switch (event.command || event.name) {
		case "view-page-source":
			var tab = activeBrowserWindow.openTab();
			activeBrowserWindow.insertTab(tab, index + 1);
			tab.url = safari.extension.baseURI + "html/viewer.html?" + encodeURIComponent(url);
			break;

		case "open-link":
			var tab = activeBrowserWindow.openTab();
			activeBrowserWindow.insertTab(tab, index + 1);
			tab.url = event.message;
			break;

		case "get-settings":
			event.target.page.dispatchMessage(event.name, JSON.stringify(safari.extension.settings));
			break;
		}
	}
	safari.application.addEventListener("command", handleEvent);
	safari.application.addEventListener("message", handleEvent);
</script>
